# nz-magic-link v0.1.4 リリースノート

リリース日: 2025-09-28

このリリースでは、エラー時のユーザー体験改善、セッションのローリング有効期限、パスキー（WebAuthn）対応の基盤追加など、実運用に向けた重要な改善を多数含みます。

## 追加（Added）
- Verify 失敗時のエラー用リダイレクトに対応（Issue #11）
  - `handlers.VerifyHandler` に `errorRedirectURL` 引数を追加し、検証エラーやトークン未指定時に、指定先へ 302 リダイレクトできるようになりました。
  - リダイレクト先には以下のクエリを付与します: `error`, `error_description`, `code`（HTTP ステータスに相当）。
  - `error_redirect` クエリで一時的な上書きも可能（http/https のみ許可）。
  - エラー・コードのマッピングをヘルパで実装（例: `token_required`, `invalid_token`, `token_expired`, `token_used`, `internal_error`）。
  - 参照: `magiclink/handlers/verify.go`

- セッション有効期間のローリング更新（Issue #12）
  - 認証済みアクセス時に、`Validate` でセッションの期限を現在時刻+`SessionExpiry` に延長し、Cookie の `Expires` も更新します（ベストエフォート）。
  - ストレージ IF に `UpdateSessionExpiry` を追加し、SQLite/LevelDB 実装を提供。
  - 参照: `magiclink/internal/session/session.go`, `magiclink/internal/storage/*.go`

- パスキー（WebAuthn/FIDO2）対応の基盤追加（実験的）
  - WebAuthn サービスとハンドラ、ストレージスキーマを追加し、今後のパスキー対応に備えました。
  - 設定で `WebAuthnEnabled` を有効化したときに利用されます。
  - 参照: `magiclink/internal/webauthn/service.go`, `magiclink/handlers/webauthn.go`, `magiclink/internal/storage/*`

## 変更（Changed）
- VerifyHandler のシグネチャ変更（破壊的変更に該当）
  - 旧: `func VerifyHandler(tokenMgr, sessionMgr, redirectURL string)`
  - 新: `func VerifyHandler(tokenMgr, sessionMgr, redirectURL, errorRedirectURL string)`
  - 既存コードは第4引数に空文字（`""`）を渡せば従来動作（JSON 応答）を維持します。

- Cookie/メール/URL 関連の設定項目を拡充
  - Cookie: `CookieSecure`, `CookieHTTPOnly`, `CookieSameSite`, `CookieDomain`, `CookiePath`
  - SMTP/TLS: `SMTPUseTLS`, `SMTPUseSTARTTLS`, `SMTPSkipVerify`
  - URL: `LoginURL`, `VerifyURL`, `RedirectURL`, `LogoutRedirectURL`, `ErrorRedirectURL`, `ServerAddr`
  - 参照: `magiclink/magiclink.go`, `magiclink/internal/session/session.go`, `magiclink/internal/email/email.go`

## 修正（Fixed）
- 使用済み/期限切れ/無効トークンに対する UX 改善
  - ブラウザで生 JSON が表示される問題を、エラー用リダイレクトによって解消（設定時）。
  - 参照: `docs/dev/issue-11-error-redirect.md`, `magiclink/handlers/verify.go`

- セッション期限が操作で延長されない問題
  - `Validate` にローリング更新を実装し、継続利用時の予期せぬログアウトを軽減。
  - 参照: `docs/dev/issue-12-session-rolling-expiry.md`, `magiclink/internal/session/session.go`

## ドキュメント（Docs）
- エラー時リダイレクト設計（#11）: `docs/dev/issue-11-error-redirect.md`
- セッション・ローリング設計（#12）: `docs/dev/issue-12-session-rolling-expiry.md`
- パスキー対応計画: `docs/dev/passkey-support-plan.md`

## サンプル（Examples）
- シンプルサンプルのテンプレート更新（ログイン/エラー/ホーム/ダッシュボード）
  - 参照: `examples/simple/templates/*.html`
- メール送信テスト用サンプル
  - 参照: `examples/email-test/*`

## 移行ガイド（Migration）
1) Verify ハンドラの関数引数を更新
   - 第4引数 `errorRedirectURL` を追加してください。未設定（空文字）の場合は従来どおり JSON 応答になります。

2) セッションのローリング更新
   - 既存の設定のままで有効になります。特別な変更は不要です。

3) ストレージ種別の確認
   - `Config.DatabaseType` に `sqlite` または `leveldb` を指定してください（デフォルトは `sqlite`）。

4) パスキー機能（実験的）
   - `WebAuthnEnabled` を有効化すると関連エンドポイント・保存処理が動作します。実運用前に十分な検証を推奨します。

## 既知の注意点
- `error_redirect` クエリによる上書きは http/https のみ許可しています。オープンリダイレクト対策のため、必要に応じて許可ドメインの制約を検討してください。
- セッションのローリング更新は現在「毎回更新（案A）」で実装しています。将来的に頻度制御（しきい値）を導入する可能性があります。

---

変更点の詳細については、各該当ファイルおよび開発ドキュメントを参照してください。