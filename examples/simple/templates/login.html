<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Magic Link Authentication Example</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 20px;
            margin-top: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="email"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        .btn {
            display: inline-block;
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            margin: 5px 0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            font-size: 16px;
        }
        .btn:hover {
            background: #45a049;
        }
        .btn-secondary {
            background: #2196F3;
        }
        .btn-secondary:hover {
            background: #0b7dda;
        }
        .btn-passkey {
            background: #FF9800;
        }
        .btn-passkey:hover {
            background: #F57C00;
        }
        .btn-passkey:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }
        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #ddd;
        }
        .divider span {
            background: white;
            padding: 0 15px;
            color: #666;
        }
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid transparent;
            border-radius: 5px;
        }
        .alert-success {
            color: #3c763d;
            background-color: #dff0d8;
            border-color: #d6e9c6;
        }
        .alert-danger {
            color: #a94442;
            background-color: #f2dede;
            border-color: #ebccd1;
        }
    </style>
</head>
<body>
    <h1>Login with Magic Link</h1>
    
    <div class="container">
        <!-- Passkey Login Section -->
        <div id="passkeySection" style="display: none;">
            <p><strong>ğŸ” ãƒ‘ã‚¹ã‚­ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³</strong></p>
            <p>ç”Ÿä½“èªè¨¼ã‚„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚­ãƒ¼ã‚’ä½¿ã£ã¦ã€ã™ã°ã‚„ãå®‰å…¨ã«ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã™ã€‚</p>

            <button id="passkeyLoginBtn" class="btn btn-passkey" style="width: 100%; margin-bottom: 10px;">
                ãƒ‘ã‚¹ã‚­ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³
            </button>
            <button id="discoverableLoginBtn" class="btn btn-passkey" style="width: 100%;">
                ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ãƒ­ã‚°ã‚¤ãƒ³
            </button>

            <div class="divider">
                <span>ã¾ãŸã¯</span>
            </div>
        </div>

        <!-- Traditional Magic Link Login -->
        <div id="magicLinkSection">
            <p>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ã€èªè¨¼ç”¨ã®ãƒã‚¸ãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’å—ã‘å–ã£ã¦ãã ã•ã„ã€‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ä¸è¦ã§ã™ï¼</p>

            <div id="message"></div>

            <form id="loginForm" action="/auth/login" method="post">
                <div class="form-group">
                    <label for="email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹:</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <button type="submit" class="btn" style="width: 100%;">ãƒã‚¸ãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’é€ä¿¡</button>

                <div class="divider">
                    <span>ã¾ãŸã¯</span>
                </div>

                <button type="button" id="registerPasskeyBtn" class="btn btn-passkey" style="width: 100%;">
                    ã“ã®ãƒ‡ãƒã‚¤ã‚¹ã§ãƒ‘ã‚¹ã‚­ãƒ¼ã‚’ä½œæˆ
                </button>
            </form>
        </div>

        <div style="margin-top: 20px; text-align: center;">
            <a href="/" class="btn btn-secondary">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a>
        </div>
    </div>

    <script>
        // WebAuthn support detection
        const isWebAuthnSupported = () => {
            return !!(navigator.credentials && navigator.credentials.create);
        };

        // Initialize page based on WebAuthn support
        document.addEventListener('DOMContentLoaded', function() {
            const passkeySection = document.getElementById('passkeySection');
            const passkeyLoginBtn = document.getElementById('passkeyLoginBtn');
            const discoverableLoginBtn = document.getElementById('discoverableLoginBtn');
            const registerPasskeyBtn = document.getElementById('registerPasskeyBtn');

            if (isWebAuthnSupported()) {
                passkeySection.style.display = 'block';

                // Check for conditional mediation support
                if (PublicKeyCredential.isConditionalMediationAvailable) {
                    PublicKeyCredential.isConditionalMediationAvailable().then(available => {
                        if (!available) {
                            discoverableLoginBtn.disabled = true;
                            discoverableLoginBtn.textContent = 'ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ãƒ­ã‚°ã‚¤ãƒ³ (éå¯¾å¿œ)';
                        }
                    });
                } else {
                    discoverableLoginBtn.disabled = true;
                    discoverableLoginBtn.textContent = 'ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ãƒ­ã‚°ã‚¤ãƒ³ (éå¯¾å¿œ)';
                }
            } else {
                registerPasskeyBtn.style.display = 'none';
            }
        });

        // Magic Link login form
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const email = document.getElementById('email').value;
            const messageDiv = document.getElementById('message');

            fetch('/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ email: email }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    let messageHtml = `<div class="alert alert-success">${data.message}</div>`;

                    if (data.magic_link) {
                        messageHtml += `
                            <div class="alert alert-success" style="margin-top: 10px;">
                                <p>é–‹ç™ºç”¨ãƒã‚¸ãƒƒã‚¯ãƒªãƒ³ã‚¯:</p>
                                <a href="${data.magic_link}" class="magic-link" style="word-break: break-all;">${data.magic_link}</a>
                            </div>
                        `;
                    }

                    messageDiv.innerHTML = messageHtml;
                    document.getElementById('email').value = '';
                } else if (data.error) {
                    messageDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                }
            })
            .catch(error => {
                messageDiv.innerHTML = `<div class="alert alert-danger">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚</div>`;
                console.error('Error:', error);
            });
        });

        // Helper functions
        const showMessage = (message, isError = false) => {
            const messageDiv = document.getElementById('message');
            const alertClass = isError ? 'alert-danger' : 'alert-success';
            messageDiv.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
        };

        // Passkey registration
        document.getElementById('registerPasskeyBtn').addEventListener('click', async function() {
            const email = document.getElementById('email').value;
            if (!email) {
                showMessage('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', true);
                return;
            }

            try {
                showMessage('ãƒ‘ã‚¹ã‚­ãƒ¼ã‚’ä½œæˆä¸­...');

                // Start registration
                const startResponse = await fetch('/webauthn/register/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email })
                });

                if (!startResponse.ok) {
                    const error = await startResponse.json();
                    throw new Error(error.message || 'ç™»éŒ²ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                const startData = await startResponse.json();
                console.log('Server response:', JSON.stringify(startData, null, 2));

                // Extract the actual PublicKeyCredentialCreationOptions from the Response field
                const publicKeyCredentialCreationOptions = startData.options.Response || startData.options.publicKey || startData.options;
                console.log('Options structure:', JSON.stringify(publicKeyCredentialCreationOptions, null, 2));

                // Check for required fields before conversion
                if (!publicKeyCredentialCreationOptions.challenge) {
                    throw new Error('Challenge field is missing from server response');
                }
                if (!publicKeyCredentialCreationOptions.user || !publicKeyCredentialCreationOptions.user.id) {
                    throw new Error('User.id field is missing from server response');
                }

                // Convert base64url strings to ArrayBuffers
                publicKeyCredentialCreationOptions.challenge = base64urlToArrayBuffer(publicKeyCredentialCreationOptions.challenge);
                publicKeyCredentialCreationOptions.user.id = base64urlToArrayBuffer(publicKeyCredentialCreationOptions.user.id);

                // Create credential
                const credential = await navigator.credentials.create({
                    publicKey: publicKeyCredentialCreationOptions
                });

                // Finish registration
                const finishResponse = await fetch('/webauthn/register/finish', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        challenge_id: startData.challenge_id,
                        response: {
                            id: credential.id,
                            rawId: Array.from(new Uint8Array(credential.rawId)),
                            response: {
                                attestationObject: Array.from(new Uint8Array(credential.response.attestationObject)),
                                clientDataJSON: Array.from(new Uint8Array(credential.response.clientDataJSON))
                            },
                            type: credential.type
                        }
                    })
                });

                if (finishResponse.ok) {
                    showMessage('ãƒ‘ã‚¹ã‚­ãƒ¼ã®ä½œæˆãŒå®Œäº†ã—ã¾ã—ãŸï¼æ¬¡å›ã‹ã‚‰ãƒ‘ã‚¹ã‚­ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã™ã€‚');
                } else {
                    const error = await finishResponse.json();
                    throw new Error(error.message || 'ç™»éŒ²ã®å®Œäº†ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

            } catch (error) {
                console.error('Passkey registration error:', error);
                showMessage('ãƒ‘ã‚¹ã‚­ãƒ¼ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, true);
            }
        });

        // Passkey login with email
        document.getElementById('passkeyLoginBtn').addEventListener('click', async function() {
            const email = prompt('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            if (!email) return;

            try {
                await passkeyLogin(email);
            } catch (error) {
                console.error('Passkey login error:', error);
                showMessage('ãƒ‘ã‚¹ã‚­ãƒ¼ã§ã®ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, true);
            }
        });

        // Discoverable login
        document.getElementById('discoverableLoginBtn').addEventListener('click', async function() {
            try {
                await passkeyLogin();
            } catch (error) {
                console.error('Discoverable login error:', error);
                showMessage('ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, true);
            }
        });

        // Common passkey login function
        async function passkeyLogin(email = null) {
            showMessage('ãƒ‘ã‚¹ã‚­ãƒ¼ã§èªè¨¼ä¸­...');

            // Start login
            const startResponse = await fetch(email ? '/webauthn/login/start' : '/webauthn/login/discoverable', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: email ? JSON.stringify({ email: email }) : '{}'
            });

            if (!startResponse.ok) {
                const error = await startResponse.json();
                throw new Error(error.message || 'ãƒ­ã‚°ã‚¤ãƒ³ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }

            const startData = await startResponse.json();

            // Get credential
            const credential = await navigator.credentials.get({
                publicKey: startData.options.publicKey
            });

            // Finish login
            const finishResponse = await fetch('/webauthn/login/finish', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    challenge_id: startData.challenge_id,
                    response: {
                        id: credential.id,
                        rawId: Array.from(new Uint8Array(credential.rawId)),
                        response: {
                            authenticatorData: Array.from(new Uint8Array(credential.response.authenticatorData)),
                            clientDataJSON: Array.from(new Uint8Array(credential.response.clientDataJSON)),
                            signature: Array.from(new Uint8Array(credential.response.signature)),
                            userHandle: credential.response.userHandle ? Array.from(new Uint8Array(credential.response.userHandle)) : null
                        },
                        type: credential.type
                    }
                })
            });

            const finishData = await finishResponse.json();
            if (finishData.success) {
                showMessage('ãƒ­ã‚°ã‚¤ãƒ³ã«æˆåŠŸã—ã¾ã—ãŸï¼ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆä¸­...');
                if (finishData.redirect_url) {
                    window.location.href = finishData.redirect_url;
                } else {
                    window.location.href = '/dashboard';
                }
            } else {
                throw new Error(finishData.message || 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // Base64URL utility functions for WebAuthn
        function base64urlToArrayBuffer(base64url) {
            if (!base64url || typeof base64url !== 'string') {
                console.error('Invalid base64url input:', base64url);
                throw new Error('Invalid base64url input: ' + base64url);
            }

            // Convert base64url to base64
            const base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
            // Add padding if needed
            const paddedBase64 = base64 + '='.repeat((4 - base64.length % 4) % 4);
            // Decode to binary string
            const binaryString = atob(paddedBase64);
            // Convert to ArrayBuffer
            const buffer = new ArrayBuffer(binaryString.length);
            const view = new Uint8Array(buffer);
            for (let i = 0; i < binaryString.length; i++) {
                view[i] = binaryString.charCodeAt(i);
            }
            return buffer;
        }

        function arrayBufferToBase64url(buffer) {
            const bytes = new Uint8Array(buffer);
            let binaryString = '';
            for (let i = 0; i < bytes.length; i++) {
                binaryString += String.fromCharCode(bytes[i]);
            }
            const base64 = btoa(binaryString);
            return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        }
    </script>
</body>
</html>